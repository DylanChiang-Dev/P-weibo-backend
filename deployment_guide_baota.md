# 寶塔面板 (Baota/aaPanel) 部署指南

本指南將協助您在 5 分鐘內完成 P-Weibo Backend 的部署，**無需手動配置數據庫或編輯文件**。

## 快速部署流程

### 步驟 1：環境準備

在寶塔面板的「**軟件商店**」中安裝以下環境：

- **Nginx**: 1.20+ 
- **MySQL**: 5.7+ 或 8.0（推薦）
- **PHP**: 8.2 或 8.3（推薦）

#### PHP 擴展檢查

在 PHP 設置中，確保已安裝以下擴展（通常默認已安裝）：
- `pdo_mysql` - 數據庫連接
- `fileinfo` - 文件上傳
- `gd` - 圖片處理
- `mbstring` - 字符串處理

---

### 步驟 2：創建網站

1. 進入「**網站**」菜單，點擊「**添加站點**」
2. 填寫配置：
   - **域名**: 您的域名或服務器 IP
   - **數據庫**: 選擇「MySQL」，記下數據庫名、用戶名和密碼
   - **PHP 版本**: 選擇 `PHP-82` 或 `PHP-83`
3. 點擊「提交」

---

### 步驟 3：上傳代碼

#### 方法 A：使用 Git（推薦）

1. SSH 進入服務器，進入網站根目錄：
   ```bash
   cd /www/wwwroot/您的域名/
   ```

2. 克隆倉庫（替換為您的倉庫地址）：
   ```bash
   git clone https://github.com/您的用戶名/P-weibo-backend.git .
   ```

#### 方法 B：手動上傳

1. 將項目文件打包為 `.zip`
2. 通過寶塔文件管理器上傳到網站根目錄
3. 解壓並刪除壓縮包

---

### 步驟 4：配置網站

#### 4.1 設置運行目錄 ⭐ 重要

1. 在網站列表中點擊「**設置**」
2. 進入「**網站目錄**」標籤
3. **運行目錄**：選擇 `/public`
4. 點擊「保存」

> **這一步非常重要！** 只有 public 目錄對外公開，才能保護源代碼安全。

#### 4.2 配置偽靜態（Nginx Rewrite）

1. 在網站設置中，進入「**偽靜態**」標籤
2. 輸入以下規則：

```nginx
location / {
    try_files $uri $uri/ /index.php?$query_string;
}
```

3. 點擊「保存」

#### 4.3 設置文件權限

1. 在寶塔文件管理器中
2. 右鍵點擊網站根目錄（例如 `pyq.3331322.xyz`）
3. 選擇「**權限**」
4. 設置：
   - **所有者**：`www`
   - **權限**：`755`
   - **勾選「應用到子目錄」**
5. 點擊「確定」

---

### 步驟 5：一鍵安裝 🚀

現在是最簡單的部分！

1. **訪問您的網站首頁**：
   ```
   https://您的域名/
   ```

2. **自動跳轉到安裝頁面**
   - 系統會自動檢測並跳轉到 `/install.html`

3. **填寫配置信息**：

   **第一步 - 數據庫配置**：
   - 數據庫主機：`127.0.0.1`
   - 數據庫名稱：（步驟 2 中創建的）
   - 數據庫用戶名：（步驟 2 中創建的）
   - 數據庫密碼：（步驟 2 中創建的）

   **第二步 - 管理員賬號**：
   - 管理員郵箱：您的郵箱
   - 管理員密碼：設置一個強密碼（至少 8 位）
   - 管理員顯示名稱：您的名字

4. **點擊「開始安裝」**

安裝程序會自動：
- ✅ 創建 `.env` 配置文件
- ✅ 生成安全的 JWT 密鑰
- ✅ 創建數據庫表結構
- ✅ 創建管理員賬號
- ✅ 創建必要的目錄

**安裝完成！** 🎉

---

## 驗證安裝

安裝成功後，測試以下端點：

1. **查看所有貼文**：
   ```
   https://您的域名/api/posts
   ```
   應返回：`{"success":true,"data":{"posts":[],"next_cursor":null}}`

2. **登錄測試**：
   ```bash
   curl -X POST https://您的域名/api/login \
     -H "Content-Type: application/json" \
     -d '{"email":"您的郵箱","password":"您的密碼"}'
   ```

3. **系統診斷**（可選）：
   ```
   https://您的域名/diagnostic.php
   ```

---

## 常見問題

### ❌ 訪問首頁顯示 404

**原因**：運行目錄未設置為 `/public`

**解決**：
1. 網站設置 → 網站目錄
2. 運行目錄選擇 `/public`
3. 保存

### ❌ API 返回 500 錯誤

**檢查步驟**：

1. **查看 PHP 錯誤日誌**：
   - 軟件商店 → PHP 8.x → 設置 → 錯誤日誌

2. **訪問診斷頁面**：
   ```
   https://您的域名/diagnostic.php
   ```

3. **確認文件權限**：
   - 確保目錄所有者為 `www`
   - 確保 `public/uploads` 和 `logs` 可寫

### ❌ 無法上傳文件

**原因**：PHP 上傳限制太小

**解決**：
1. 軟件商店 → PHP 8.x → 設置 → 配置文件
2. 修改：
   ```ini
   upload_max_filesize = 100M
   post_max_size = 100M
   ```
3. 保存並重啟 PHP

### ❌ 重新安裝

如需重新安裝：

1. 刪除根目錄下的 `.env` 和 `.installed` 文件
2. 訪問首頁，會自動跳轉到安裝頁面

---

## 後續維護

### 更新代碼

```bash
cd /www/wwwroot/您的域名/
git pull origin main
```

### 查看日誌

日誌文件位於：`/www/wwwroot/您的域名/logs/`

---

## 安全建議

1. ✅ 安裝完成後，設置強密碼
2. ✅ 定期更新代碼
3. ✅ 啟用 HTTPS（寶塔面板可一鍵申請 SSL 證書）
4. ✅ 定期備份數據庫

---

## 需要幫助？

- 查看 API 文檔：`/api_documentation.md`
- 系統診斷：`https://您的域名/diagnostic.php`
