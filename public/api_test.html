<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P-Weibo API Test</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.5; }
        h2 { border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 30px; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 5px; }
        .form-group { margin-bottom: 10px; }
        label { display: inline-block; width: 80px; font-weight: bold; }
        input, textarea { width: 300px; padding: 5px; }
        button { padding: 5px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #a71d2a; }
        #output { background: #f8f9fa; padding: 15px; border: 1px solid #ddd; border-radius: 5px; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>P-Weibo API Test Console</h1>
    
    <div id="auth-status" style="background: #e9ecef; padding: 10px; margin-bottom: 20px; border-radius: 5px;">
        Status: <span id="status-text">Not Logged In</span>
        <button id="logout-btn" class="hidden danger" onclick="logout()">Logout</button>
    </div>

    <div id="output">Log output will appear here...</div>

    <!-- Auth Section -->
    <div class="section">
        <h2>Authentication</h2>
        <div class="form-group">
            <label>Username:</label> <input type="text" id="auth-user" value="testuser">
        </div>
        <div class="form-group">
            <label>Email:</label> <input type="email" id="auth-email" value="test@example.com">
        </div>
        <div class="form-group">
            <label>Password:</label> <input type="password" id="auth-pass" value="password123">
        </div>
        <button onclick="register()">Register</button>
        <button onclick="login()">Login</button>
        <button onclick="getMe()">Get Me</button>
    </div>

    <!-- Post Section -->
    <div class="section">
        <h2>Posts</h2>
        <div class="form-group">
            <label>Content:</label> <textarea id="post-content">Hello World!</textarea>
        </div>
        <button onclick="createPost()">Create Post</button>
        <button onclick="getPosts()">List Posts</button>
    </div>

    <!-- User Profile Section -->
    <div class="section">
        <h2>User Profile</h2>
        <div class="form-group">
            <label>Username:</label> <input type="text" id="profile-user" value="testuser">
        </div>
        <button onclick="getProfile()">Get Profile</button>
    </div>

    <script>
        const API_URL = 'http://localhost:8080/api';
        let token = localStorage.getItem('token');

        function updateStatus() {
            const statusEl = document.getElementById('status-text');
            const logoutBtn = document.getElementById('logout-btn');
            if (token) {
                statusEl.textContent = 'Logged In';
                statusEl.style.color = 'green';
                logoutBtn.classList.remove('hidden');
            } else {
                statusEl.textContent = 'Not Logged In';
                statusEl.style.color = 'red';
                logoutBtn.classList.add('hidden');
            }
        }

        function log(data, title = 'Result') {
            const out = document.getElementById('output');
            const time = new Date().toLocaleTimeString();
            out.textContent = `[${time}] ${title}:\n${JSON.stringify(data, null, 2)}\n\n` + out.textContent;
        }

        async function request(endpoint, method = 'GET', body = null) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            
            const opts = { method, headers };
            if (body) opts.body = JSON.stringify(body);

            try {
                const res = await fetch(API_URL + endpoint, opts);
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || res.statusText);
                return data;
            } catch (err) {
                log({ error: err.message }, `Error (${endpoint})`);
                throw err;
            }
        }

        async function register() {
            const username = document.getElementById('auth-user').value;
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-pass').value;
            try {
                const res = await request('/register', 'POST', { username, email, password });
                log(res, 'Register Success');
            } catch (e) {}
        }

        async function login() {
            const username = document.getElementById('auth-user').value;
            const password = document.getElementById('auth-pass').value;
            try {
                const res = await request('/login', 'POST', { username, password });
                if (res.data && res.data.access_token) {
                    token = res.data.access_token;
                    localStorage.setItem('token', token);
                    updateStatus();
                    log(res, 'Login Success');
                }
            } catch (e) {}
        }

        function logout() {
            token = null;
            localStorage.removeItem('token');
            updateStatus();
            log({}, 'Logged Out');
        }

        async function getMe() {
            try {
                const res = await request('/me');
                log(res, 'My Info');
            } catch (e) {}
        }

        async function createPost() {
            const content = document.getElementById('post-content').value;
            try {
                const res = await request('/posts', 'POST', { content });
                log(res, 'Create Post Success');
                getPosts(); // Refresh list
            } catch (e) {}
        }

        async function getPosts() {
            try {
                const res = await request('/posts');
                log(res, 'Post List');
            } catch (e) {}
        }

        async function getProfile() {
            const username = document.getElementById('profile-user').value;
            try {
                const res = await request(`/users/${username}`);
                log(res, 'User Profile');
            } catch (e) {}
        }

        async function deletePost(id) {
            if (!confirm('Delete this post?')) return;
            try {
                const res = await request(`/posts/${id}`, 'DELETE');
                log(res, 'Delete Post Success');
                getPosts();
            } catch (e) {}
        }

        // Init
        updateStatus();
    </script>
</body>
</html>
